<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€ä¸ªæ•°æ¯”å¦ä¸€ä¸ªæ•°å°‘å‡  - å„¿ç«¥æ•°å­¦å­¦ä¹ å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Comic Sans MS', 'Marker Felt', 'å¹¼åœ†', cursive;
        }
        
        body {
            background-color: #f0f9ff;
            background-image: radial-gradient(#c5e3ff 2px, transparent 2px);
            background-size: 30px 30px;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: white;
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 100, 200, 0.15);
            border: 8px solid #ffcc70;
            position: relative;
            overflow: hidden;
        }
        
        /* è£…é¥°æ€§å…ƒç´  */
        .decoration {
            position: absolute;
            z-index: 0;
        }
        
        .decoration-1 {
            top: 10px;
            left: 10px;
            width: 60px;
            height: 60px;
            background-color: #ff9966;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .decoration-2 {
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 80px;
            background-color: #66ccff;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        .decoration-3 {
            top: 50%;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: #99ff99;
            border-radius: 50%;
            opacity: 0.3;
        }
        
        /* æ ‡é¢˜åŒºåŸŸ */
        .title {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            z-index: 1;
        }
        
        h1 {
            color: #ff6b6b;
            font-size: 2.8rem;
            text-shadow: 3px 3px 0 #ffcc70;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }
        
        .subtitle {
            color: #4d96ff;
            font-size: 1.4rem;
            font-weight: bold;
        }
        
        /* ç”»å¸ƒåŒºåŸŸ */
        .canvas-container {
            background-color: #e6f7ff;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            border: 6px dashed #4d96ff;
            position: relative;
            z-index: 1;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            width: 100%;
        }
        
        #drawingCanvas {
            width: 100%;
            height: 220px;
            border-radius: 15px;
            background-color: white;
        }
        
        /* é—®é¢˜åŒºåŸŸ */
        .question-area {
            background-color: #fff9e6;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 5px solid #ffcc70;
            position: relative;
            z-index: 1;
        }
        
        .question-row {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 1.8rem;
        }
        
        .question-row:last-child {
            margin-bottom: 0;
        }
        
        .emoji-placeholder {
            display: inline-block;
            width: 40px;
            height: 40px;
            text-align: center;
            font-size: 30px;
            vertical-align: middle;
        }
        
        .dropdown {
            padding: 10px 15px;
            border-radius: 12px;
            border: 3px solid #4d96ff;
            background-color: white;
            font-size: 1.5rem;
            color: #333;
            min-width: 100px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(77, 150, 255, 0.3);
        }
        
        .number-input {
            padding: 10px 15px;
            border-radius: 12px;
            border: 3px solid #ff9966;
            background-color: white;
            font-size: 1.5rem;
            width: 100px;
            text-align: center;
            color: #333;
        }
        
        .number-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 153, 102, 0.3);
        }
        
        .error-circle {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #ff3333;
            animation: pulse 1s infinite;
            transform: translate(-25px, 10px);
            display: none;
        }
        
        @keyframes pulse {
            0% { transform: translate(-25px, 10px) scale(1); opacity: 1; }
            50% { transform: translate(-25px, 10px) scale(1.2); opacity: 0.8; }
            100% { transform: translate(-25px, 10px) scale(1); opacity: 1; }
        }
        
        /* æŒ‰é’®åŒºåŸŸ */
        .button-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            position: relative;
            z-index: 1;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 18px 35px;
            border: none;
            border-radius: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2);
        }
        
        .btn-confirm {
            background-color: #4dff4d;
            color: #006600;
        }
        
        .btn-confirm:hover {
            background-color: #33cc33;
        }
        
        .btn-result {
            background-color: #ffcc00;
            color: #996600;
        }
        
        .btn-result:hover {
            background-color: #e6b800;
        }
        
        .btn-next {
            background-color: #4d96ff;
            color: white;
        }
        
        .btn-next:hover {
            background-color: #3377cc;
        }
        
        .btn-next:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            color: #666666;
        }
        
        .emoji-btn {
            font-size: 2rem;
        }
        
        /* åé¦ˆåŒºåŸŸ */
        .feedback {
            margin-top: 25px;
            padding: 20px;
            border-radius: 20px;
            font-size: 1.8rem;
            text-align: center;
            font-weight: bold;
            display: none;
            position: relative;
            z-index: 1;
            animation: popIn 0.5s;
        }
        
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .feedback.correct {
            background-color: #ccffcc;
            color: #006600;
            border: 5px solid #4dff4d;
        }
        
        .feedback.incorrect {
            background-color: #ffcccc;
            color: #990000;
            border: 5px solid #ff6666;
        }
        
        /* ç»“æœæ ‡è®° */
        .result-marker {
            position: absolute;
            font-size: 3rem;
            z-index: 10;
            display: none;
            animation: bounce 0.5s;
            text-align: center;
        }
        
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }
        
        .result-correct {
            color: #00cc00;
        }
        
        .result-incorrect {
            color: #ff0000;
        }
        
        /* è§¦å±ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .question-row {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 15px 25px;
                font-size: 1.5rem;
            }
            
            .button-area {
                flex-direction: column;
                gap: 15px;
            }
            
            .dropdown, .number-input {
                font-size: 1.3rem;
                padding: 8px 12px;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .dropdown, .number-input {
                min-height: 50px;
                min-width: 120px;
            }
            
            .btn {
                min-height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è£…é¥°æ€§å…ƒç´  -->
        <div class="decoration decoration-1"></div>
        <div class="decoration decoration-2"></div>
        <div class="decoration decoration-3"></div>
        
        <!-- æ ‡é¢˜ -->
        <div class="title">
            <h1>ä¸€ä¸ªæ•°æ¯”å¦ä¸€ä¸ªæ•°å°‘å‡ </h1>
            <div class="subtitle">æ•°ä¸€æ•°ï¼Œæ¯”ä¸€æ¯”ï¼Œçœ‹è°å¤šè°å°‘</div>
        </div>
        
        <!-- ç»˜å›¾åŒº -->
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="950" height="220"></canvas>
        </div>
        
        <!-- é—®é¢˜åŒºåŸŸ -->
        <div class="question-area">
            <div class="question-row">
                <span id="emojiA1" class="emoji-placeholder"></span>
                æ¯”
                <span id="emojiB1" class="emoji-placeholder"></span>
                <select id="dropdownM" class="dropdown">
                    <option value="">ç©ºç™½</option>
                    <option value="å°‘">å°‘</option>
                </select>
                <input type="number" id="numberN1" class="number-input" placeholder="æ•°å­—" min="0">
                ä¸ªã€‚
                <div id="error1" class="error-circle"></div>
            </div>
            
            <div class="question-row">
                <span id="emojiA2" class="emoji-placeholder"></span>
                æœ‰
                <input type="number" id="numberN2" class="number-input" placeholder="æ•°å­—" min="0">
                ä¸ªï¼Œ
                <div id="error2" class="error-circle"></div>
            </div>
            
            <div class="question-row">
                <span id="emojiB2" class="emoji-placeholder"></span>
                æœ‰
                <input type="number" id="numberN3" class="number-input" placeholder="æ•°å­—" min="0">
                ä¸ªã€‚
                <div id="error3" class="error-circle"></div>
            </div>
        </div>
        
        <!-- æŒ‰é’®åŒºåŸŸ -->
        <div class="button-area">
            <button id="confirmBtn" class="btn btn-confirm">
                <span class="emoji-btn">âœ…</span> ç¡®å®š
            </button>
            <button id="resultBtn" class="btn btn-result">
                <span class="emoji-btn">ğŸ“</span> ç»“æœ
            </button>
            <button id="nextBtn" class="btn btn-next" disabled>
                <span class="emoji-btn">â¡ï¸</span> ä¸‹ä¸€é¢˜
            </button>
        </div>
        
        <!-- åé¦ˆåŒºåŸŸ -->
        <div id="feedback" class="feedback"></div>
        
        <!-- ç»“æœæ ‡è®° -->
        <div id="resultMarker" class="result-marker"></div>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="errorSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <audio id="successSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" type="audio/mpeg">
    </audio>
    <audio id="nextSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-game-show-wrong-answer-buzz-950.mp3" type="audio/mpeg">
    </audio>
    <audio id="voiceCorrect" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
    </audio>
    <audio id="voiceIncorrect" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3" type="audio/mpeg">
    </audio>
    <!-- æ–°å¢è¯­éŸ³æç¤º -->
    <audio id="congratsSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3" type="audio/mpeg">
    </audio>
    <audio id="sorrySound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-sad-game-over-trombone-471.mp3" type="audio/mpeg">
    </audio>

    <!-- è¯­éŸ³åˆæˆå¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
        // è¯­éŸ³åˆæˆå‡½æ•°ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.9; // ç¨æ…¢çš„è¯­é€Ÿ
                utterance.pitch = 1.2; // ç¨é«˜çš„éŸ³è°ƒï¼Œé€‚åˆå„¿ç«¥
                speechSynthesis.speak(utterance);
            }
        }
        
        // æ’­æ”¾æ­å–œè¯­éŸ³
        function playCongratsSound() {
            const audio = document.getElementById('congratsSound');
            audio.currentTime = 0;
            audio.play().catch(e => {
                console.log("æ­å–œè¯­éŸ³æ’­æ”¾è¢«é˜»æ­¢ï¼Œä½¿ç”¨è¯­éŸ³åˆæˆ");
                speakText("æ­å–œï¼é€šå…³æˆåŠŸï¼");
            });
        }
        
        // æ’­æ”¾æŠ±æ­‰è¯­éŸ³
        function playSorrySound() {
            const audio = document.getElementById('sorrySound');
            audio.currentTime = 0;
            audio.play().catch(e => {
                console.log("æŠ±æ­‰è¯­éŸ³æ’­æ”¾è¢«é˜»æ­¢ï¼Œä½¿ç”¨è¯­éŸ³åˆæˆ");
                speakText("éå¸¸æŠ±æ­‰ï¼Œä½ è¿˜éœ€è¦åŠªåŠ›å“¦");
            });
        }
    </script>

    <script>
        // å¯ç”¨emojiåˆ—è¡¨ï¼ˆæ°´æœï¼‰
        const emojiList = ["ğŸ", "ğŸŒ", "ğŸ‡", "ğŸ“", "ğŸ‰", "ğŸŠ", "ğŸ‘", "ğŸ’", "ğŸ¥­", "ğŸ", "ğŸ¥", "ğŸ"];
        
        // å½“å‰é—®é¢˜æ•°æ®
        let currentData = {
            emojiA: "",
            emojiB: "",
            countA: 0,
            countB: 0
        };
        
        // æ§åˆ¶çº¢è‰²åœ†åœˆæ˜¾ç¤ºçš„æ ‡å¿—
        let showRedCircle = false;
        // è®°å½•æ˜¯å¦å·²ç»å›ç­”æ­£ç¡®
        let isAnsweredCorrectly = false;
        // è®°å½•æ­£ç¡®ç­”æ¡ˆ
        let correctAnswer = {
            m: "å°‘",
            n1: 0,
            n2: 0,
            n3: 0
        };
        
        // DOMå…ƒç´ 
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const emojiA1 = document.getElementById('emojiA1');
        const emojiA2 = document.getElementById('emojiA2');
        const emojiB1 = document.getElementById('emojiB1');
        const emojiB2 = document.getElementById('emojiB2');
        const dropdownM = document.getElementById('dropdownM');
        const numberN1 = document.getElementById('numberN1');
        const numberN2 = document.getElementById('numberN2');
        const numberN3 = document.getElementById('numberN3');
        const confirmBtn = document.getElementById('confirmBtn');
        const resultBtn = document.getElementById('resultBtn');
        const nextBtn = document.getElementById('nextBtn');
        const feedback = document.getElementById('feedback');
        const resultMarker = document.getElementById('resultMarker');
        const errorSound = document.getElementById('errorSound');
        const successSound = document.getElementById('successSound');
        const nextSound = document.getElementById('nextSound');
        const voiceCorrect = document.getElementById('voiceCorrect');
        const voiceIncorrect = document.getElementById('voiceIncorrect');
        const errorCircles = [
            document.getElementById('error1'),
            document.getElementById('error2'),
            document.getElementById('error3')
        ];
        
        // åˆå§‹åŒ–
        function init() {
            // ç”Ÿæˆç¬¬ä¸€é¢˜
            generateNewQuestion();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            confirmBtn.addEventListener('click', checkAnswer);
            resultBtn.addEventListener('click', showResult);
            nextBtn.addEventListener('click', generateNewQuestion);
            
            // è¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†è·å¾—ç„¦ç‚¹æ—¶ç§»é™¤é”™è¯¯æç¤º
            dropdownM.addEventListener('focus', () => hideError(0));
            numberN1.addEventListener('focus', () => hideError(0));
            numberN2.addEventListener('focus', () => hideError(1));
            numberN3.addEventListener('focus', () => hideError(2));
            
            // è¾“å…¥æ¡†å˜åŒ–æ—¶éšè—ç»“æœæ ‡è®°å¹¶ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            dropdownM.addEventListener('change', () => {
                hideResultMarker();
                nextBtn.disabled = true;
                isAnsweredCorrectly = false;
            });
            numberN1.addEventListener('input', () => {
                hideResultMarker();
                nextBtn.disabled = true;
                isAnsweredCorrectly = false;
            });
            numberN2.addEventListener('input', () => {
                hideResultMarker();
                nextBtn.disabled = true;
                isAnsweredCorrectly = false;
            });
            numberN3.addEventListener('input', () => {
                hideResultMarker();
                nextBtn.disabled = true;
                isAnsweredCorrectly = false;
            });
            
            // è§¦å±è®¾å¤‡ä¼˜åŒ–
            setupTouchEvents();
        }
        
        // ç”Ÿæˆæ–°é¢˜ç›®
        function generateNewQuestion() {
            // æ’­æ”¾éŸ³æ•ˆ
            nextSound.currentTime = 0;
            nextSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢ï¼Œç”¨æˆ·éœ€è¦ä¸é¡µé¢äº¤äº’"));
            
            // æ¸…é™¤ä¹‹å‰çš„è¾“å…¥å’Œåé¦ˆ
            clearInputs();
            hideFeedback();
            hideResultMarker();
            
            // é‡ç½®çŠ¶æ€
            showRedCircle = false;
            isAnsweredCorrectly = false;
            nextBtn.disabled = true;
            
            // éšæœºé€‰æ‹©ä¸¤ç§ä¸åŒçš„emoji
            const emojiIndexA = Math.floor(Math.random() * emojiList.length);
            let emojiIndexB;
            do {
                emojiIndexB = Math.floor(Math.random() * emojiList.length);
            } while (emojiIndexB === emojiIndexA);
            
            currentData.emojiA = emojiList[emojiIndexA];
            currentData.emojiB = emojiList[emojiIndexB];
            
            // ç”Ÿæˆéšæœºæ•°é‡ï¼ˆ5-20ä¹‹é—´ï¼Œä¸”ä¸ç›¸ç­‰ï¼‰
            currentData.countA = Math.floor(Math.random() * 16) + 5; // 5-20
            do {
                currentData.countB = Math.floor(Math.random() * 16) + 5;
            } while (currentData.countA === currentData.countB);
            
            // ç¡®ä¿Açš„æ•°é‡å°äºBçš„æ•°é‡ï¼Œè¿™æ ·å°±æ˜¯"å°‘å‡ "
            if (currentData.countA > currentData.countB) {
                [currentData.countA, currentData.countB] = [currentData.countB, currentData.countA];
                [currentData.emojiA, currentData.emojiB] = [currentData.emojiB, currentData.emojiA];
            }
            
            // è®¡ç®—æ­£ç¡®ç­”æ¡ˆ
            correctAnswer.m = "å°‘";
            correctAnswer.n1 = currentData.countB - currentData.countA;
            correctAnswer.n2 = currentData.countA;
            correctAnswer.n3 = currentData.countB;
            
            // æ›´æ–°ç•Œé¢
            updateEmojiDisplay();
            drawEmojisOnCanvas();
        }
        
        // æ›´æ–°emojiæ˜¾ç¤º
        function updateEmojiDisplay() {
            // åªæ˜¾ç¤ºemojiï¼Œä¸æ˜¾ç¤ºæ•°é‡ï¼ˆé”»ç‚¼å­¦ç”Ÿçš„æ•°å­—æ„ŸçŸ¥èƒ½åŠ›ï¼‰
            emojiA1.textContent = currentData.emojiA;
            emojiA2.textContent = currentData.emojiA;
            emojiB1.textContent = currentData.emojiB;
            emojiB2.textContent = currentData.emojiB;
        }
        
        // åœ¨Canvasä¸Šç»˜åˆ¶emoji
        function drawEmojisOnCanvas() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¾ç½®å­—ä½“å¤§å°
            const emojiSize = 32;
            ctx.font = `${emojiSize}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            const padding = 15;
            const rowHeight = 80;
            const startX = 30; // å·¦å¯¹é½èµ·å§‹ä½ç½®
            
            // ç»˜åˆ¶ç¬¬ä¸€è¡Œï¼ˆAï¼‰- å·¦å¯¹é½
            const row1Y = rowHeight;
            const countA = currentData.countA;
            
            for (let i = 0; i < countA; i++) {
                const x = startX + i * (emojiSize + padding);
                const y = row1Y;
                
                // æ·»åŠ ä¸€ç‚¹éšæœºåç§»ï¼Œä½¿çœ‹èµ·æ¥æ›´ç”ŸåŠ¨
                const offsetX = Math.sin(i * 0.5) * 2;
                const offsetY = Math.cos(i * 0.7) * 2;
                
                ctx.fillText(currentData.emojiA, x + offsetX, y + offsetY);
            }
            
            // ç»˜åˆ¶ç¬¬äºŒè¡Œï¼ˆBï¼‰- å·¦å¯¹é½
            const row2Y = rowHeight + 100;
            const countB = currentData.countB;
            
            for (let i = 0; i < countB; i++) {
                const x = startX + i * (emojiSize + padding);
                const y = row2Y;
                
                // æ·»åŠ ä¸€ç‚¹éšæœºåç§»ï¼Œä½¿çœ‹èµ·æ¥æ›´ç”ŸåŠ¨
                const offsetX = Math.sin(i * 0.3 + 1) * 2;
                const offsetY = Math.cos(i * 0.5 + 1) * 2;
                
                ctx.fillText(currentData.emojiB, x + offsetX, y + offsetY);
            }
            
            // å¦‚æœæ ‡å¿—ä¸ºtrueï¼Œç»˜åˆ¶çº¢è‰²åœ†åœˆ
            if (showRedCircle) {
                drawRedCircle();
            }
            
            // ç»˜åˆ¶åˆ†éš”çº¿
            ctx.beginPath();
            ctx.moveTo(20, rowHeight + 50);
            ctx.lineTo(canvas.width - 20, rowHeight + 50);
            ctx.lineWidth = 3;
            ctx.strokeStyle = "#ff9966";
            ctx.setLineDash([5, 5]);
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // ç»˜åˆ¶çº¢è‰²åœ†åœˆåœˆå‡ºå¤šå‡ºçš„å›¾å½¢
        function drawRedCircle() {
            const emojiSize = 32;
            const padding = 15;
            const rowHeight = 80;
            const startX = 30;
            
            // è®¡ç®—å¤šå‡ºçš„æ•°é‡
            const extraCount = currentData.countB - currentData.countA;
            
            // å¦‚æœæœ‰å¤šå‡ºçš„å›¾å½¢ï¼Œç”¨ä¸€æ ¹çº¢è‰²çº¿æ¡ç”»æˆåœ†åœˆåœˆèµ·æ¥
            if (extraCount > 0) {
                const row2Y = rowHeight + 100;
                const countB = currentData.countB;
                
                // è®¡ç®—éœ€è¦åœˆèµ·æ¥çš„å›¾å½¢çš„ä½ç½®
                const startIndex = countB - extraCount;
                const endIndex = countB - 1;
                
                // è®¡ç®—åœ†åœˆçš„å‚æ•°
                const firstX = startX + startIndex * (emojiSize + padding);
                const lastX = startX + endIndex * (emojiSize + padding);
                const centerX = (firstX + lastX) / 2;
                const centerY = row2Y;
                const radiusX = (lastX - firstX) / 2 + emojiSize/2 + 10;
                const radiusY = emojiSize/2 + 15;
                
                // ç»˜åˆ¶çº¢è‰²æ¤­åœ†ï¼ˆçœ‹èµ·æ¥åƒä¸€ä¸ªåœ†åœˆï¼‰
                ctx.beginPath();
                ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
                ctx.lineWidth = 4;
                ctx.strokeStyle = "#ff3333";
                ctx.stroke();
                
                // åœ¨åœ†åœˆæ—è¾¹æ·»åŠ "å¤šå‡º"çš„æç¤º
                ctx.font = "bold 20px Arial";
                ctx.fillStyle = "#ff3333";
                ctx.textAlign = "center";
                ctx.fillText("å¤šå‡º " + extraCount + " ä¸ª", centerX, row2Y + radiusY + 25);
                
                // æ·»åŠ è¿æ¥çº¿ï¼Œä»ç¬¬ä¸€è¡Œæœ«å°¾è¿æ¥åˆ°ç¬¬äºŒè¡Œå¤šå‡ºçš„éƒ¨åˆ†
                if (currentData.countA > 0) {
                    const lastAX = startX + (currentData.countA - 1) * (emojiSize + padding);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastAX + emojiSize/2, rowHeight + 5);
                    ctx.lineTo(firstX - 5, row2Y - radiusY + 5);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = "#ff3333";
                    ctx.setLineDash([5, 3]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // åœ¨è¿æ¥çº¿ä¸­é—´æ·»åŠ ç®­å¤´
                    const arrowX = (lastAX + firstX) / 2;
                    const arrowY = (rowHeight + row2Y - radiusY) / 2;
                    drawArrow(ctx, arrowX, arrowY, 10, "#ff3333");
                }
            }
        }
        
        // ç»˜åˆ¶ç®­å¤´
        function drawArrow(context, x, y, size, color) {
            context.save();
            context.fillStyle = color;
            context.beginPath();
            context.moveTo(x, y - size/2);
            context.lineTo(x - size, y + size/2);
            context.lineTo(x + size, y + size/2);
            context.closePath();
            context.fill();
            context.restore();
        }
        
        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœªå¡«å†™çš„å­—æ®µ
            let hasError = false;
            
            // æ£€æŸ¥ä¸‹æ‹‰æ¡†æ˜¯å¦é€‰æ‹©äº†"ç©ºç™½"
            if (dropdownM.value === "") {
                showError(0);
                hasError = true;
            }
            
            // æ£€æŸ¥æ•°å­—è¾“å…¥æ¡†æ˜¯å¦ä¸ºç©º
            if (numberN1.value === "" || numberN1.value === "0") {
                showError(0);
                hasError = true;
            }
            
            if (numberN2.value === "" || numberN2.value === "0") {
                showError(1);
                hasError = true;
            }
            
            if (numberN3.value === "" || numberN3.value === "0") {
                showError(2);
                hasError = true;
            }
            
            // å¦‚æœæœ‰æœªå¡«å†™çš„å­—æ®µï¼Œæ’­æ”¾é”™è¯¯éŸ³æ•ˆå¹¶è¿”å›
            if (hasError) {
                errorSound.currentTime = 0;
                errorSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                feedback.textContent = "è¯·å¡«å†™æ‰€æœ‰ç©ºç™½å¤„å“¦ï¼";
                feedback.className = "feedback incorrect";
                feedback.style.display = "block";
                return;
            }
            
            // è·å–ç”¨æˆ·è¾“å…¥
            const userM = dropdownM.value;
            const userN1 = parseInt(numberN1.value);
            const userN2 = parseInt(numberN2.value);
            const userN3 = parseInt(numberN3.value);
            
            // æ£€æŸ¥ç­”æ¡ˆ
            const isMCorrect = userM === correctAnswer.m;
            const isN1Correct = userN1 === correctAnswer.n1;
            const isN2Correct = userN2 === correctAnswer.n2;
            const isN3Correct = userN3 === correctAnswer.n3;
            
            // æ˜¾ç¤ºåé¦ˆ
            if (isMCorrect && isN1Correct && isN2Correct && isN3Correct) {
                // ç­”æ¡ˆæ­£ç¡®
                successSound.currentTime = 0;
                successSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                
                // æ’­æ”¾è¯­éŸ³åé¦ˆ
                setTimeout(() => {
                    voiceCorrect.currentTime = 0;
                    voiceCorrect.play().catch(e => console.log("è¯­éŸ³æ’­æ”¾è¢«é˜»æ­¢"));
                }, 500);
                
                feedback.textContent = "å¤ªæ£’äº†ï¼ç­”å¯¹äº†ï¼ğŸ‰ ä½ çœŸæ˜¯å¤ªæ£’å•¦ï¼";
                feedback.className = "feedback correct";
                
                // æ˜¾ç¤ºçº¢è‰²åœ†åœˆ
                showRedCircle = true;
                isAnsweredCorrectly = true;
                nextBtn.disabled = false; // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
                drawEmojisOnCanvas();
                
                // æ·»åŠ åº†ç¥æ•ˆæœ
                addCelebrationEffect();
            } else {
                // ç­”æ¡ˆé”™è¯¯
                errorSound.currentTime = 0;
                errorSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                
                // æ’­æ”¾è¯­éŸ³åé¦ˆ
                setTimeout(() => {
                    voiceIncorrect.currentTime = 0;
                    voiceIncorrect.play().catch(e => console.log("è¯­éŸ³æ’­æ”¾è¢«é˜»æ­¢"));
                }, 500);
                
                feedback.textContent = `ç­”æ¡ˆä¸æ­£ç¡®ï¼Œè¯·é‡æ–°è¾“å…¥ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${currentData.emojiA}æ¯”${currentData.emojiB}å°‘${correctAnswer.n1}ä¸ªï¼Œ${currentData.emojiA}æœ‰${correctAnswer.n2}ä¸ªï¼Œ${currentData.emojiB}æœ‰${correctAnswer.n3}ä¸ªã€‚`;
                feedback.className = "feedback incorrect";
                
                // ä¸æ¸…é™¤ç­”æ¡ˆï¼Œè®©å­¦ç”Ÿä¿®æ”¹
                isAnsweredCorrectly = false;
                nextBtn.disabled = true; // ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            }
            
            feedback.style.display = "block";
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å­—æ®µéƒ½å·²å¡«å†™
            let hasError = false;
            
            if (dropdownM.value === "") {
                showError(0);
                hasError = true;
            }
            
            if (numberN1.value === "" || numberN1.value === "0") {
                showError(0);
                hasError = true;
            }
            
            if (numberN2.value === "" || numberN2.value === "0") {
                showError(1);
                hasError = true;
            }
            
            if (numberN3.value === "" || numberN3.value === "0") {
                showError(2);
                hasError = true;
            }
            
            if (hasError) {
                errorSound.currentTime = 0;
                errorSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                feedback.textContent = "è¯·å…ˆå¡«å†™æ‰€æœ‰ç©ºç™½å¤„ï¼";
                feedback.className = "feedback incorrect";
                feedback.style.display = "block";
                return;
            }
            
            // è·å–ç”¨æˆ·è¾“å…¥
            const userM = dropdownM.value;
            const userN1 = parseInt(numberN1.value);
            const userN2 = parseInt(numberN2.value);
            const userN3 = parseInt(numberN3.value);
            
            // æ£€æŸ¥ç­”æ¡ˆ
            const isMCorrect = userM === correctAnswer.m;
            const isN1Correct = userN1 === correctAnswer.n1;
            const isN2Correct = userN2 === correctAnswer.n2;
            const isN3Correct = userN3 === correctAnswer.n3;
            
            // æ˜¾ç¤ºç»“æœæ ‡è®°
            if (isMCorrect && isN1Correct && isN2Correct && isN3Correct) {
                // æ˜¾ç¤ºæ­£ç¡®æ ‡è®°
                showResultMarker("âœ…", "æ­£ç¡®", "result-correct");
                successSound.currentTime = 0;
                successSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                
                // æ’­æ”¾æ­å–œè¯­éŸ³
                setTimeout(() => {
                    playCongratsSound();
                }, 300);
                
                // æ˜¾ç¤ºçº¢è‰²åœ†åœˆ
                showRedCircle = true;
                isAnsweredCorrectly = true;
                nextBtn.disabled = false; // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
                drawEmojisOnCanvas();
            } else {
                // æ˜¾ç¤ºé”™è¯¯æ ‡è®°
                showResultMarker("âŒ", "é”™è¯¯", "result-incorrect");
                errorSound.currentTime = 0;
                errorSound.play().catch(e => console.log("éŸ³é¢‘æ’­æ”¾è¢«é˜»æ­¢"));
                
                // æ’­æ”¾æŠ±æ­‰è¯­éŸ³
                setTimeout(() => {
                    playSorrySound();
                }, 300);
                
                isAnsweredCorrectly = false;
                nextBtn.disabled = true; // ç¦ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®
            }
            
            // éšè—åé¦ˆåŒºåŸŸï¼Œå› ä¸ºç»“æœæ ‡è®°å·²ç»æ˜¾ç¤ºäº†
            hideFeedback();
        }
        
        // æ˜¾ç¤ºç»“æœæ ‡è®°
        function showResultMarker(emoji, text, className) {
            // è®¾ç½®æ ‡è®°ä½ç½®ï¼ˆåœ¨æŒ‰é’®åŒºåŸŸä¸Šæ–¹ï¼‰
            const buttonArea = document.querySelector('.button-area');
            const rect = buttonArea.getBoundingClientRect();
            const containerRect = document.querySelector('.container').getBoundingClientRect();
            
            resultMarker.innerHTML = `${emoji}<br><span style="font-size: 2rem;">${text}</span>`;
            resultMarker.className = `result-marker ${className}`;
            resultMarker.style.left = '50%';
            resultMarker.style.top = (rect.top - containerRect.top - 80) + 'px';
            resultMarker.style.transform = 'translateX(-50%)';
            resultMarker.style.display = 'block';
        }
        
        // éšè—ç»“æœæ ‡è®°
        function hideResultMarker() {
            resultMarker.style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        function showError(index) {
            errorCircles[index].style.display = "block";
        }
        
        // éšè—é”™è¯¯æç¤º
        function hideError(index) {
            errorCircles[index].style.display = "none";
        }
        
        // æ¸…é™¤è¾“å…¥
        function clearInputs() {
            // è®¾ç½®é»˜è®¤å€¼ï¼šä¸‹æ‹‰æ¡†é»˜è®¤ä¸ºç©ºç™½ï¼Œæ•°å­—è¾“å…¥æ¡†é»˜è®¤ä¸ºç©ºç™½
            dropdownM.selectedIndex = 0; // ç©ºç™½é€‰é¡¹
            numberN1.value = "";
            numberN2.value = "";
            numberN3.value = "";
            
            // éšè—æ‰€æœ‰é”™è¯¯æç¤º
            errorCircles.forEach(circle => circle.style.display = "none");
        }
        
        // éšè—åé¦ˆ
        function hideFeedback() {
            feedback.style.display = "none";
        }
        
        // æ·»åŠ åº†ç¥æ•ˆæœ
        function addCelebrationEffect() {
            // åœ¨ç”»å¸ƒä¸Šæ·»åŠ ä¸€äº›åº†ç¥å…ƒç´ 
            const emojiSize = 32;
            const celebrationEmojis = ["ğŸ‰", "ğŸŠ", "ğŸŒŸ", "âœ¨", "ğŸ¥³"];
            
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const emoji = celebrationEmojis[Math.floor(Math.random() * celebrationEmojis.length)];
                    
                    ctx.font = "25px Arial";
                    ctx.fillText(emoji, x, y);
                    
                    // 2ç§’åæ¸…é™¤è¿™ä¸ªemoji
                    setTimeout(() => {
                        // é‡ç»˜ç”»å¸ƒï¼ˆä¿ç•™çº¢è‰²åœ†åœˆï¼‰
                        drawEmojisOnCanvas();
                    }, 2000);
                }, i * 200);
            }
        }
        
        // è®¾ç½®è§¦æ‘¸äº‹ä»¶
        function setupTouchEvents() {
            // ä¸ºæ‰€æœ‰å¯äº¤äº’å…ƒç´ æ·»åŠ è§¦æ‘¸åé¦ˆ
            const interactiveElements = document.querySelectorAll('.dropdown, .number-input, .btn');
            
            interactiveElements.forEach(el => {
                el.addEventListener('touchstart', function() {
                    if (!this.disabled) {
                        this.style.transform = 'scale(0.95)';
                    }
                });
                
                el.addEventListener('touchend', function() {
                    if (!this.disabled) {
                        this.style.transform = 'scale(1)';
                    }
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>